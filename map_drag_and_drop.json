{
  "widgetsBundle": {
    "alias": "test_widget2",
    "title": "Map drag & drop",
    "image": null
  },
  "widgetTypes": [
    {
      "alias": "label_widget",
      "name": "WIDGET MAP",
      "descriptor": {
        "type": "latest",
        "sizeX": 4.5,
        "sizeY": 5,
        "resources": [],
        "templateHtml": "",
        "templateCss": "#container {\n    overflow: auto;\n}\n\n.dot {\n  height: 1.000rem;\n  width: 1.000rem;\n  background-color: #bbb;\n  border-radius: 50%;\n  display: inline-block;\n  border: solid black;\n  border-width: thin;\n}\n\n.tbDatasource-container {\n    margin: 5px;\n    padding: 8px;\n}\n\n.tbDatasource-title {\n    font-size: 1.200rem;\n    font-weight: 500;\n    padding-bottom: 10px;\n}\n\n.tbDatasource-table {\n    width: 100%;\n    box-shadow: 0 0 10px #ccc;\n    border-collapse: collapse;\n    white-space: nowrap;\n    font-size: 1.000rem;\n    color: #757575;\n}\n\n.tbDatasource-table td {\n    position: relative;\n    border-top: 1px solid rgba(0, 0, 0, 0.12);\n    border-bottom: 1px solid rgba(0, 0, 0, 0.12);\n    padding: 0px 18px;\n    box-sizing: border-box;\n}\n\n.tooltip {\n  position: absolute;\n  display: inline-block;\n  /*border-bottom: 1px dotted black;*/\n}\n\n.tooltip .tooltiptext {\n  visibility: hidden;\n  width: 210px;\n  background-color: black;\n  font-size: 10px;\n  color: #fff;\n  text-align: center;\n  border-radius: 6px;\n  padding: 5px 5px;\n  \n  /* Position the tooltip */\n  position: absolute;\n  z-index: 1;\n}\n\n.tooltip:hover .tooltiptext {\n  visibility: visible;\n  top: 105%;\n  left: 0%;\n  /*transform: translateX(-50%); */\n}\n\n",
        "controllerScript": "self.onInit = function() {\n    self.ctx.varsRegex = /\\$\\{([^\\}]*)\\}/g;\n    var imageUrl = self.ctx.settings.backgroundImageUrl ? self.ctx.settings.backgroundImageUrl :\n    'data:image/svg+xml;base64,PHN2ZyBpZD0ic3ZnMiIgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMTAwIiB3aWR0aD0iMTAwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zOmNjPSJodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9ucyMiIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgdmlld0JveD0iMCAwIDEwMCAxMDAiPgogPGcgaWQ9ImxheWVyMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCAtOTUyLjM2KSI+CiAgPHJlY3QgaWQ9InJlY3Q0Njg0IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBoZWlnaHQ9Ijk5LjAxIiB3aWR0aD0iOTkuMDEiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiB5PSI5NTIuODYiIHg9Ii40OTUwNSIgc3Ryb2tlLXdpZHRoPSIuOTkwMTAiIGZpbGw9IiNlZWUiLz4KICA8dGV4dCBpZD0idGV4dDQ2ODYiIHN0eWxlPSJ3b3JkLXNwYWNpbmc6MHB4O2xldHRlci1zcGFjaW5nOjBweDt0ZXh0LWFuY2hvcjptaWRkbGU7dGV4dC1hbGlnbjpjZW50ZXIiIGZvbnQtd2VpZ2h0PSJib2xkIiB4bWw6c3BhY2U9InByZXNlcnZlIiBmb250LXNpemU9IjEwcHgiIGxpbmUtaGVpZ2h0PSIxMjUlIiB5PSI5NzAuNzI4MDkiIHg9IjQ5LjM5NjQ3NyIgZm9udC1mYW1pbHk9IlJvYm90byIgZmlsbD0iIzY2NjY2NiI+PHRzcGFuIGlkPSJ0c3BhbjQ2OTAiIHg9IjUwLjY0NjQ3NyIgeT0iOTcwLjcyODA5Ij5JbWFnZSBiYWNrZ3JvdW5kIDwvdHNwYW4+PHRzcGFuIGlkPSJ0c3BhbjQ2OTIiIHg9IjQ5LjM5NjQ3NyIgeT0iOTgzLjIyODA5Ij5pcyBub3QgY29uZmlndXJlZDwvdHNwYW4+PC90ZXh0PgogIDxyZWN0IGlkPSJyZWN0NDY5NCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgaGVpZ2h0PSIxOS4zNiIgd2lkdGg9IjY5LjM2IiBzdHJva2U9IiMwMDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgeT0iOTkyLjY4IiB4PSIxNS4zMiIgc3Ryb2tlLXdpZHRoPSIuNjM5ODYiIGZpbGw9Im5vbmUiLz4KIDwvZz4KPC9zdmc+Cg==';\n    var div_img = document.createElement(\"div\");\n    div_img.setAttribute(\"id\", \"divImg\");\n    var bgImg = $('<img />');\n    bgImg.hide();\n    bgImg.bind('load', function()\n    {\n        self.ctx.bImageHeight = $(this).height();\n        self.ctx.bImageWidth = $(this).width();\n        self.onResize();\n    });\n    //self.ctx.$container.append(bgImg);\n    bgImg.attr('src', imageUrl);\n    div_img.append(bgImg[0]);\n    self.ctx.$container.append(div_img);\n    \n    self.ctx.$container.css('background', 'url(\"'+imageUrl+'\") no-repeat');\n    self.ctx.$container.css('backgroundSize', 'contain');\n    self.ctx.$container.css('backgroundPosition', '50% 50%');\n\n    function processLabelPattern(pattern, data) {\n        var match = self.ctx.varsRegex.exec(pattern);\n        var replaceInfo = {};\n        replaceInfo.variables = [];\n        while (match !== null) {\n            var variableInfo = {};\n            variableInfo.dataKeyIndex = -1;\n            var variable = match[0];\n            var label = match[1];\n            var valDec = 2;\n            var splitVals = label.split(':');\n            if (splitVals.length > 1) {\n                label = splitVals[0];\n                valDec = parseFloat(splitVals[1]);\n            }\n            variableInfo.variable = variable;\n            variableInfo.valDec = valDec;\n            if (label.startsWith('#')) {\n                var keyIndexStr = label.substring(1);\n                var n = Math.floor(Number(keyIndexStr));\n                if (String(n) === keyIndexStr && n >= 0) {\n                    variableInfo.dataKeyIndex = n;\n                }\n            }\n            if (variableInfo.dataKeyIndex === -1) {\n                for (var i = 0; i < data.length; i++) {\n                     var datasourceData = data[i];\n                     var dataKey = datasourceData.dataKey;\n                     if (dataKey.label === label) {\n                         variableInfo.dataKeyIndex = i;\n                         break;\n                     }\n                }\n            }\n            replaceInfo.variables.push(variableInfo);\n            match = self.ctx.varsRegex.exec(pattern);\n            \n        }\n        return replaceInfo;\n    }\n    var configuredLabels = self.ctx.settings.labels;\n    if (!configuredLabels) {\n        configuredLabels = [];\n    }\n    \n    self.ctx.labels = [];\n    for (var l = 0; l < configuredLabels.length; l++) {\n        var labelConfig = configuredLabels[l];\n        var localConfig = {};\n        localConfig.font = {};\n        \n        localConfig.pattern = labelConfig.pattern ? labelConfig.pattern : '${#0}';\n        //localConfig.pattern = self.ctx.data[self.firstData(l)].data.toString().split(\",\")[1];\n        localConfig.x = labelConfig.x ? labelConfig.x : 0;\n        localConfig.y = labelConfig.y ? labelConfig.y : 0;\n        localConfig.backgroundColor = labelConfig.backgroundColor ? labelConfig.backgroundColor : 'rgba(0,0,0,0)';\n        \n        var settingsFont = labelConfig.font;\n        if (!settingsFont) {\n            settingsFont = {};\n        }\n        \n        localConfig.font.family = settingsFont.family || 'Roboto';\n        localConfig.font.size = settingsFont.size ? settingsFont.size : 6;\n        localConfig.font.style = settingsFont.style ? settingsFont.style : 'normal';\n        localConfig.font.weight = settingsFont.weight ? settingsFont.weight : '500';\n        localConfig.font.color = settingsFont.color ? settingsFont.color : '#fff';\n        localConfig.replaceInfo = processLabelPattern(localConfig.pattern, self.ctx.data);\n\n        for (var iDevice = 0; iDevice < self.ctx.datasources.length; iDevice++) {\n            var label = {};\n            var labelElement = $('<div/>');\n            labelElement.css('position', 'absolute');\n            labelElement.css('display', 'none');\n            labelElement.css('top', '10%');\n            //self.ctx.settings.labels[0].y[iDevice] = 10;\n            labelElement.css('left', (iDevice*25 + 5).toString() + '%');\n            //self.ctx.settings.labels[0].x[iDevice] = (iDevice*25 + 5);\n            labelElement.css('backgroundColor', localConfig.backgroundColor);\n            labelElement.css('color', localConfig.font.color);\n            labelElement.css('fontFamily', localConfig.font.family);\n            labelElement.css('fontStyle', localConfig.font.style);\n            labelElement.css('fontWeight', localConfig.font.weight);\n            labelElement.css('text-align', 'center');\n            labelElement.html(localConfig.pattern);\n            self.ctx.$container.append(labelElement);\n            label.element = labelElement;\n            label.config = localConfig;\n            label.htmlSet = false;\n            label.visible = false;\n            self.ctx.labels.push(label);\n            labelElement[0].setAttribute(\"class\", \"tooltip\");\n            labelElement[0].setAttribute(\"id\", \"labelCanne\" + iDevice);\n            labelElement[0].setAttribute(\"draggable\", \"true\");\n            labelElement[0].setAttribute(\"ondragstart\", \"drag(event)\");\n        }\n    }\n    var container = document.getElementsByTagName(\"body\")[0];\n    container.setAttribute(\"ondrop\", \"drop(event, self)\");\n    container.setAttribute(\"ondragover\", \"allowDrop(event)\");\n    var head = document.getElementsByTagName(\"head\")[0];\n    var script = document.createElement(\"script\");\n    const scriptHTML = `\n    function drag(ev){\n        ev.dataTransfer.setData(\"Text\", ev.target.id);\n    }\n    function allowDrop(ev) {\n        ev.preventDefault();\n    }\n    function drop(event, self){\n        event.preventDefault();\n        var data = event.dataTransfer.getData(\"Text\");\n        event.target.appendChild(document.getElementById(data));\n        var elementDraged = document.getElementById(data);\n        const ind = Number(elementDraged.id.substring(10));\n        if(self.test_widget.PossibleGPS(ind)) {\n            return;\n        }\n        var posX = event.layerX - elementDraged.offsetWidth / 2;\n        var posY = event.layerY - elementDraged.offsetHeight / 2;\n        elementDraged.style.left = posX + 'px';\n        elementDraged.style.top = posY + 'px';\n        const rect = document.getElementById(\"divImg\").getBoundingClientRect();\n        var labels = self.test_widget.ctx.labels;\n        const offsetX = (1 - self.test_widget.ctx.backgroundRect.xRatio)*self.test_widget.ctx.width/2;\n        const offsetY = (1 - self.test_widget.ctx.backgroundRect.yRatio)*self.test_widget.ctx.height/2;\n        const ratioX = (posX - offsetX)/rect.width*100;\n        const ratioY = (posY - offsetY)/rect.height*100;\n        self.test_widget.onPositionsChange(ind, ratioX, ratioY);\n        const button = document.getElementsByClassName(\"tb-btn-footer md-accent md-hue-2 md-fab md-button ng-scope md-ink-ripple ng-hide\")[0];\n        if (angular.element(button).scope() !== undefined) {\n            angular.element(button).scope().vm.saveDashboard();\n            console.log(\"dashboard save\");\n        }\n     }`;\n    \n    \n    script.innerHTML = scriptHTML;\n    head.append(script);\n    window.test_widget = self;\n    self.onDataUpdated();\n}\n\nself.onDataUpdated = function() {\n    updateLabels();\n    setInterval(updateLabels, 60000);\n}\n\nself.onResize = function() {\n    if (self.ctx.bImageHeight && self.ctx.bImageWidth) {\n        var backgroundRect = {};\n        var imageRatio = self.ctx.bImageWidth / self.ctx.bImageHeight;\n        var componentRatio = self.ctx.width / self.ctx.height;\n        if (componentRatio >= imageRatio) {\n            backgroundRect.top = 0;\n            backgroundRect.bottom = 1.0;\n            backgroundRect.xRatio = imageRatio / componentRatio;\n            backgroundRect.yRatio = 1;\n            var offset = (1 - backgroundRect.xRatio) / 2;\n            backgroundRect.left = offset;\n            backgroundRect.right = 1 - offset;\n        } else {\n            backgroundRect.left = 0;\n            backgroundRect.right = 1.0;\n            backgroundRect.xRatio = 1;\n            backgroundRect.yRatio = componentRatio / imageRatio;\n            var offset = (1 - backgroundRect.yRatio) / 2;\n            backgroundRect.top = offset;\n            backgroundRect.bottom = 1 - offset;\n        }\n        var div_img = document.getElementById(\"divImg\");\n        div_img.setAttribute(\"style\", \"height:\" + backgroundRect.yRatio*100 + \"%;width:\" + (backgroundRect.xRatio*100).toFixed(2) + \"%;\");\n        for (var l = 0; l < self.ctx.labels.length; l++) {\n            var label = self.ctx.labels[l];\n            var labelLeft = backgroundRect.left*100 + (label.config.x*backgroundRect.xRatio);\n            var labelTop = backgroundRect.top*100 + (label.config.y*backgroundRect.yRatio);\n            var fontSize = self.ctx.height * backgroundRect.yRatio * label.config.font.size / 100;\n            //label.element.css('top', labelTop + '%');\n            //label.element.css('left', labelLeft + '%');\n            label.element.css('fontSize', fontSize + 'px');\n            if (!label.visible) {\n                label.element.css('display', 'block');\n                label.visible = true;\n            }\n        }\n        self.ctx.backgroundRect = backgroundRect;\n        \n    } \n}\n\n\nfunction isNumber(n) {\n    return !isNaN(parseFloat(n)) && isFinite(n);\n}\n\nfunction padValue(val, dec, int) {\n    var i = 0;\n    var s, strVal, n;\n\n    val = parseFloat(val);\n    n = (val < 0);\n    val = Math.abs(val);\n\n    if (dec > 0) {\n        strVal = val.toFixed(dec).toString().split('.');\n        s = int - strVal[0].length;\n\n        for (; i < s; ++i) {\n            strVal[0] = '0' + strVal[0];\n        }\n\n        strVal = (n ? '-' : '') + strVal[0] + '.' + strVal[1];\n    }\n\n    else {\n        strVal = Math.round(val).toString();\n        s = int - strVal.length;\n\n        for (; i < s; ++i) {\n            strVal = '0' + strVal;\n        }\n\n        strVal = (n ? '-' : '') + strVal;\n    }\n\n    return strVal;\n}\n\nfunction updateLabels() {\n    for (var l = 0; l < self.ctx.labels.length; l++) {\n        var label = self.ctx.labels[l];\n        var text = label.config.pattern;\n        var replaceInfo = label.config.replaceInfo;\n        var updated = false;\n        for (var v = 0; v < replaceInfo.variables.length; v++) {\n            var variableInfo = replaceInfo.variables[v];\n            var txtVal = '';\n            if (variableInfo.dataKeyIndex > -1) {\n                var varData = self.ctx.data[variableInfo.dataKeyIndex].data;\n                if (varData.length > 0) {\n                    var val = varData[varData.length-1][1];\n                    if (isNumber(val)) {\n                        txtVal = padValue(val, variableInfo.valDec, 0);\n                        updated = true;\n                    } else {\n                        txtVal = val;\n                        updated = true;\n                    }\n                }\n            }\n            text = text.split(variableInfo.variable).join(txtVal);\n        }\n        if (updated || !label.htmlSet) {\n            label.element.html(self.ctx.data[self.firstData(l)].data.toString().split(\",\")[1]);\n            if (self.DeviceType(l).type == \"canne\") {\n                if (document.getElementById('ledDetect' + l) === null) {\n                    var retourLigne = document.createElement('br');\n                    label.element[0].append(retourLigne);\n                \n                    var newSpan = document.createElement('span');\n                    newSpan.setAttribute(\"class\", \"dot\");\n                    newSpan.setAttribute(\"id\", \"ledDetect\" + l);\n                    if (self.ctx.backgroundRect !== undefined) {\n                        var fontSize = self.ctx.height * self.ctx.backgroundRect.yRatio * label.config.font.size / 100;\n                        newSpan.style.height = fontSize + 'px';\n                        newSpan.style.width = fontSize + 'px';\n                    }\n                    if (self.ctx.data[6*l + 1] !== undefined) {\n                        var array = new Object(self.ctx.data[6*l + 1].data[0]);\n                        const detection = array.toString().split(',')[1];\n                        switch(detection) {\n                            case '0':\n                                newSpan.style['background-color'] = 'purple';\n                                break;\n                            case '1':\n                                newSpan.style['background-color'] = 'green';\n                                break;\n                            case '2':\n                                newSpan.style['background-color'] = 'blue';\n                                break;\n                            case '3':\n                                newSpan.style['background-color'] = 'black';\n                                break;\n                            case '4':\n                                newSpan.style['background-color'] = 'red';\n                                break;\n                            default:\n                                newSpan.style['background-color'] = 'yellow';\n                                break;\n                        }\n                    } else {\n                        newSpan.style['background-color'] = 'yellow';\n                    }\n                    label.element[0].append(newSpan);\n                }\n            } else {\n                var retourLigne = document.createElement('br');\n                label.element[0].append(retourLigne);\n                \n                var newSpan = document.createElement('span');\n                newSpan.setAttribute(\"class\", \"dot\");\n                newSpan.setAttribute(\"id\", \"ledDetect\" + l);\n                label.element[0].append(newSpan);\n            }\n            if (document.getElementById('spanCanneText' + l) === null) {\n                var newSpan = document.createElement('span');\n                newSpan.setAttribute(\"class\", \"tooltiptext\");\n                newSpan.setAttribute(\"id\", \"spanCanneText\" + l);\n                newSpan.style['font-size'] = '12px';\n                \n                newSpan.innerHTML = self.getData(l);\n                \n                label.element[0].append(newSpan);\n            }\n            if (!self.PossibleGPS(l)) {\n                self.onPositionsChange(l, self.ctx.settings.labels[0].x[l], self.ctx.settings.labels[0].y[l]);\n            }\n        }\n        if (!label.htmlSet) {\n            label.htmlSet = true;\n        }\n    }\n}\n\n\nself.onDestroy = function() {\n}\n\nself.PossibleGPS = function(l) {\n    //on reajuste d'abord le tooltiptext pour qu'il ne dépasse pas\n    const div_img = document.getElementById(\"divImg\").getBoundingClientRect();\n    const divLabelRect = document.getElementById(\"labelCanne\" + l).getBoundingClientRect();\n    var span = document.getElementById(\"spanCanneText\" + l);\n    var debord = false;\n    if (span != null) {\n        const spanRect = span.getBoundingClientRect();\n        const divContainer = document.getElementById(\"container\");\n        const margeY = (divContainer.clientWidth - div_img.width) / 2;\n        const margeX = (divContainer.clientHeight - div_img.height) / 2;\n        if ((spanRect.left  < div_img.left) && (spanRect.left != 0)) {\n            span.style.top = (50*(1 - spanRect.height/divLabelRect.height)).toString() + '%';\n            span.style.left = ((divLabelRect.width + 5)/divLabelRect.width*100 ).toString() + '%';\n            debord = true;\n        }\n        if (((spanRect.x + spanRect.width) > (div_img.right + margeX)) && (spanRect.x != 0)){\n            span.style.top = (50*(1 - spanRect.height/divLabelRect.height)).toString() + '%';\n            span.style.left = (0 - (spanRect.width + 5)/divLabelRect.width*100 ).toString() + '%';\n            debord = true;\n        }\n        if (((spanRect.y + spanRect.height) > (div_img.bottom + margeY)) && (spanRect.y != 0)) {\n            span.style.top = (0 - (spanRect.height + 5)/divLabelRect.height*100 ).toString() + '%';\n            span.style.left = (50*(1 - spanRect.width/divLabelRect.width)).toString() + '%';\n            debord = true;\n        }\n        if (!debord) {\n            span.style.top = ((divLabelRect.height + 5)/divLabelRect.height*100 ).toString() + '%';\n            span.style.left = (50*(1 - spanRect.width/divLabelRect.width)).toString() + '%';\n        }\n    }\n    \n    var long = self.findKey('longitude', l);\n    var lat = self.findKey('latitude', l);\n    if (long < 0) {\n        return;\n    }\n    if (lat < 0) {\n        return;\n    }\n    \n    if (self.ctx.settings.mapConfig !== undefined) {\n        var array = new Object(self.ctx.data[self.firstData(l) + lat].data[0]);\n        const latLabel = Number(array.toString().split(',')[1]);\n        array = new Object(self.ctx.data[self.firstData(l) + long].data[0]);\n        const lonLabel = Number(array.toString().split(',')[1]);\n        const settingsMapHG = self.ctx.settings.mapConfig.CornerTop;\n        const settingsMapBD = self.ctx.settings.mapConfig.CornerBot;\n        if (isNaN(latLabel) || isNaN(lonLabel) || (self.ctx.settings.mapConfig.GPSautoPlacement === false)) {\n            // si lat ou long non définies || mode non placement avec le GPS\n            return false;\n        } else  {\n            if ((latLabel > settingsMapHG.latitude) || (lonLabel < settingsMapHG.longitude)) {\n                return false;\n                \n            } else {\n                if ((latLabel < settingsMapBD.latitude) || (lonLabel > settingsMapBD.longitude)) {\n                    return false;\n                } else {\n                    const largeurLabel = document.getElementById(\"labelCanne\" + l).getBoundingClientRect().width/2;\n                    const largeurImg = document.getElementById(\"divImg\").getBoundingClientRect().width;\n                    const ratioCentreY = largeurLabel / largeurImg * 100;\n                    const hauteurLabel = document.getElementById(\"labelCanne\" + l).getBoundingClientRect().height;\n                    const hauteurImg = document.getElementById(\"divImg\").getBoundingClientRect().height;\n                    const ratioCentreX = hauteurLabel / hauteurImg * 100;\n                    const newX = (settingsMapHG.latitude - latLabel)/(settingsMapHG.latitude - settingsMapBD.latitude)*100 - ratioCentreX;\n                    const newY = 100 - (settingsMapBD.longitude - lonLabel)/(settingsMapBD.longitude - settingsMapHG.longitude)*100 - ratioCentreY;\n                    self.onPositionsChange(l, newY,  newX);\n                    return true;\n                }\n            }\n        }\n        return false;\n    }\n    return false;\n}\n\nself.onPositionsChange = function (indice, newX, newY) {\n    const pourcentPadding = 3;\n    if (newX < pourcentPadding) {\n        newX = pourcentPadding;\n    }\n    if (newY < pourcentPadding) {\n        newY = pourcentPadding;\n    }\n    if (newX > 100 - pourcentPadding) {\n        newX = 100 - pourcentPadding;\n    }\n    if (newY > 100 - pourcentPadding) {\n        newY = 100 - pourcentPadding;\n    }\n    var id = self.ctx.dashboard.widgetIds[0];\n\n    console.log(newX, newY, indice);\n    self.ctx.settings.labels[0].x[indice] = newX ;\n    self.ctx.settings.labels[0].y[indice] = newY ;\n    console.log(self.ctx.settings.labels);\n    var div = document.getElementById('labelCanne' + indice);\n    div.style.left = newX + '%';\n    div.style.top = newY + '%';\n}\n\n\nself.DeviceType = function (indice) {\n    var freturn = new Object();\n    if (self.ctx.datasources[indice].entity !== undefined) {\n        freturn.type= self.ctx.datasources[indice].entity.type;\n        freturn.entityId = self.ctx.datasources[indice].entityId;\n        freturn.nkeys = self.ctx.datasources[indice].dataKeys.length; \n   }\n    return freturn;\n}\n\nself.getData = function (indice) {\n    const data = self.ctx.data;\n    const device = self.DeviceType(indice);\n    var text = \"\";\n    const offsetTab = self.firstData(indice);\n\n    for (var i=0; i < device.nkeys; i++) {\n        if (data[i + offsetTab].dataKey.name != 'name') {\n            const dataValue = data[i + offsetTab].data.toString().split(\",\")[1];\n            text += \"<i><u>\" +  data[i + offsetTab].dataKey.name + \" :</u></i> \" + dataValue + \"<br>\";\n        }\n    }\n    return text;\n}\n\nself.firstData = function (indice) {\n    var firstData = 0;\n    for (var i=0; i < indice; i++) {\n        if (self.ctx.datasources[i] !== undefined) {\n            firstData += self.ctx.datasources[i].dataKeys.length;\n        }\n        else {\n            return -1;\n        }\n    }\n    return firstData;\n}\n\nself.findKey = function(strKey, l) {\n    var DeviceType = self.DeviceType(l);\n    const firstData = self.firstData(l);\n    for (var i = 0; i < DeviceType.nkeys; i++) {\n        if (self.ctx.data[firstData + i].dataKey.name == strKey) {\n            return i;\n        }\n    }\n    return -1;\n}\n",
        "settingsSchema": "{\n    \"schema\": {\n        \"type\": \"object\",\n        \"title\": \"Settings\",\n        \"required\": [\"backgroundImageUrl\"],\n        \"properties\": {\n            \"backgroundImageUrl\": {\n                \"title\": \"Background image\",\n                \"type\": \"string\",\n                \"default\": \"data:image/svg+xml;base64,PHN2ZyBpZD0ic3ZnMiIgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMTAwIiB3aWR0aD0iMTAwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zOmNjPSJodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9ucyMiIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgdmlld0JveD0iMCAwIDEwMCAxMDAiPgogPGcgaWQ9ImxheWVyMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCAtOTUyLjM2KSI+CiAgPHJlY3QgaWQ9InJlY3Q0Njg0IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBoZWlnaHQ9Ijk5LjAxIiB3aWR0aD0iOTkuMDEiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiB5PSI5NTIuODYiIHg9Ii40OTUwNSIgc3Ryb2tlLXdpZHRoPSIuOTkwMTAiIGZpbGw9IiNlZWUiLz4KICA8dGV4dCBpZD0idGV4dDQ2ODYiIHN0eWxlPSJ3b3JkLXNwYWNpbmc6MHB4O2xldHRlci1zcGFjaW5nOjBweDt0ZXh0LWFuY2hvcjptaWRkbGU7dGV4dC1hbGlnbjpjZW50ZXIiIGZvbnQtd2VpZ2h0PSJib2xkIiB4bWw6c3BhY2U9InByZXNlcnZlIiBmb250LXNpemU9IjEwcHgiIGxpbmUtaGVpZ2h0PSIxMjUlIiB5PSI5NzAuNzI4MDkiIHg9IjQ5LjM5NjQ3NyIgZm9udC1mYW1pbHk9IlJvYm90byIgZmlsbD0iIzY2NjY2NiI+PHRzcGFuIGlkPSJ0c3BhbjQ2OTAiIHg9IjUwLjY0NjQ3NyIgeT0iOTcwLjcyODA5Ij5JbWFnZSBiYWNrZ3JvdW5kIDwvdHNwYW4+PHRzcGFuIGlkPSJ0c3BhbjQ2OTIiIHg9IjQ5LjM5NjQ3NyIgeT0iOTgzLjIyODA5Ij5pcyBub3QgY29uZmlndXJlZDwvdHNwYW4+PC90ZXh0PgogIDxyZWN0IGlkPSJyZWN0NDY5NCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgaGVpZ2h0PSIxOS4zNiIgd2lkdGg9IjY5LjM2IiBzdHJva2U9IiMwMDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgeT0iOTkyLjY4IiB4PSIxNS4zMiIgc3Ryb2tlLXdpZHRoPSIuNjM5ODYiIGZpbGw9Im5vbmUiLz4KIDwvZz4KPC9zdmc+Cg==\"\n            },\n            \"mapConfig\": {\n                \"title\":\"Configuration de la carte\",\n                \"type\": \"object\",\n                \"properties\": {\n                    \"CornerTop\" : {\n                        \"title\":\"Coin supérieur gauche\",\n                        \"type\": \"object\",\n                        \"properties\" :{\n                            \"latitude\" : {\n                                \"title\":\"Latitude\",\n                                \"type\" : \"number\",\n                                \"default\": 43.645763\n                            },\n                            \"longitude\" : {\n                                \"title\":\"Longitude\",\n                                \"type\" : \"number\",\n                                \"default\": 5.014226\n                            }\n                        }\n                    },\n                    \"CornerBot\" : {\n                        \"title\":\"Coin inférieur droit\",\n                        \"type\": \"object\",\n                        \"properties\" :{\n                            \"latitude\" : {\n                                \"title\":\"Latitude\",\n                                \"type\" : \"number\",\n                                \"default\": 43.640372\n                            },\n                            \"longitude\" : {\n                                \"title\":\"Longitude\",\n                                \"type\" : \"number\",\n                                \"default\": 5.023174\n                            }\n                        }\n                    },\n                    \"GPSautoPlacement\" : {\n                        \"title\": \"Placement des dispositifs avec les coordonnées GPS\",\n                        \"type\": \"boolean\"\n                    }\n                }\n            },\n            \"labels\": {\n                \"title\": \"Labels\",\n                \"type\": \"array\",\n                \"items\": {\n                   \"title\": \"Label\",\n                   \"type\": \"object\",\n                   \"required\": [\"pattern\"],\n                   \"properties\": {\n                       \"pattern\": {\n                           \"title\": \"Pattern ( for ex. 'Text ${keyName} units.' or '${#<key index>} units'  )\",\n                           \"type\": \"string\",\n                           \"default\": \"${#0}\"\n                       },\n                       \"x\": {\n                           \"title\": \"X (Percentage relative to background)\",\n                           \"type\": \"array\",\n                           \"items\" : {\n                               \"type\" : \"number\",\n                               \"default\": 12\n                           }\n                       },\n                       \"y\": {\n                           \"title\": \"Y (Percentage relative to background)\",\n                           \"type\": \"array\",\n                           \"items\" : {\n                               \"type\" : \"number\",\n                               \"default\": 12\n                           }\n                       },\n                       \"backgroundColor\": {\n                           \"title\": \"Backround color\",\n                           \"type\": \"string\",\n                           \"default\": \"rgba(0,0,0,0)\"\n                       },\n                       \"font\": {\n                           \"type\": \"object\",\n                           \"properties\": {\n                               \"family\": {\n                                    \"title\": \"Font family\",\n                                    \"type\": \"string\",\n                                    \"default\": \"Roboto\"\n                                },\n                                \"size\": {\n                                    \"title\": \"Relative font size (percents)\",\n                                    \"type\": \"number\",\n                                    \"default\": 6\n                                },\n                                \"style\": {\n                                    \"title\": \"Style\",\n                                    \"type\": \"string\",\n                                    \"default\": \"normal\"\n                                },\n                                \"weight\": {\n                                    \"title\": \"Weight\",\n                                    \"type\": \"string\",\n                                    \"default\": \"500\"\n                                },\n                                \"color\": {\n                                    \"title\": \"color\",\n                                    \"type\": \"string\",\n                                    \"default\": \"#fff\"\n                                }\n                           }\n                       }\n                   }\n                }\n            }\n        }\n    },\n    \"form\": [\n        {\n            \"key\": \"backgroundImageUrl\",\n            \"type\": \"image\"\n        },\n        {\n            \"key\": \"mapConfig\",\n            \"items\":  [\n                {\n                    \"key\": \"mapConfig.CornerTop\",\n                    \"items\": [\n                        \"mapConfig.CornerTop.latitude\",\n                        \"mapConfig.CornerTop.longitude\"\n                    ]\n                },\n                {\n                    \"key\": \"mapConfig.CornerBot\",\n                    \"items\": [\n                        \"mapConfig.CornerBot.latitude\",\n                        \"mapConfig.CornerBot.longitude\"\n                    ]\n                },\n                {\n                    \"key\" : \"mapConfig.GPSautoPlacement\"\n                }\n            ]\n        },\n        {\n            \"key\": \"labels\",\n            \"items\": [\n                {\n                    \"key\": \"labels[].backgroundColor\",\n                    \"type\": \"color\"\n                },\n                \"labels[].font.family\",\n                \"labels[].font.size\",\n                {\n                   \"key\": \"labels[].font.style\",\n                   \"type\": \"rc-select\",\n                   \"multiple\": false,\n                   \"items\": [\n                       {\n                           \"value\": \"normal\",\n                           \"label\": \"Normal\"\n                       },\n                       {\n                           \"value\": \"italic\",\n                           \"label\": \"Italic\"\n                       },\n                       {\n                           \"value\": \"oblique\",\n                           \"label\": \"Oblique\"\n                       }\n                    ]\n\n                },\n                {\n                   \"key\": \"labels[].font.weight\",\n                   \"type\": \"rc-select\",\n                   \"multiple\": false,\n                   \"items\": [\n                       {\n                           \"value\": \"normal\",\n                           \"label\": \"Normal\"\n                       },\n                       {\n                           \"value\": \"bold\",\n                           \"label\": \"Bold\"\n                       },\n                       {\n                           \"value\": \"bolder\",\n                           \"label\": \"Bolder\"\n                       },\n                       {\n                           \"value\": \"lighter\",\n                           \"label\": \"Lighter\"\n                       },\n                       {\n                           \"value\": \"100\",\n                           \"label\": \"100\"\n                       },\n                       {\n                           \"value\": \"200\",\n                           \"label\": \"200\"\n                       },\n                       {\n                           \"value\": \"300\",\n                           \"label\": \"300\"\n                       },\n                       {\n                           \"value\": \"400\",\n                           \"label\": \"400\"\n                       },\n                       {\n                           \"value\": \"500\",\n                           \"label\": \"500\"\n                       },\n                       {\n                           \"value\": \"600\",\n                           \"label\": \"600\"\n                       },\n                       {\n                           \"value\": \"700\",\n                           \"label\": \"800\"\n                       },\n                       {\n                           \"value\": \"800\",\n                           \"label\": \"800\"\n                       },\n                       {\n                           \"value\": \"900\",\n                           \"label\": \"900\"\n                       }\n                    ]\n                },\n                {\n                    \"key\": \"labels[].font.color\",\n                    \"type\": \"color\"\n                }\n            ]\n        }\n    ]\n}",
        "dataKeySettingsSchema": "{}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"var\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"backgroundImageUrl\":\"data:image/svg+xml;base64,PHN2ZyBpZD0ic3ZnMiIgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMTAwIiB3aWR0aD0iMTAwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zOmNjPSJodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9ucyMiIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgdmlld0JveD0iMCAwIDEwMCAxMDAiPgogPGcgaWQ9ImxheWVyMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCAtOTUyLjM2KSI+CiAgPHJlY3QgaWQ9InJlY3Q0Njg0IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBoZWlnaHQ9Ijk5LjAxIiB3aWR0aD0iOTkuMDEiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiB5PSI5NTIuODYiIHg9Ii40OTUwNSIgc3Ryb2tlLXdpZHRoPSIuOTkwMTAiIGZpbGw9IiNlZWUiLz4KICA8dGV4dCBpZD0idGV4dDQ2ODYiIHN0eWxlPSJ3b3JkLXNwYWNpbmc6MHB4O2xldHRlci1zcGFjaW5nOjBweDt0ZXh0LWFuY2hvcjptaWRkbGU7dGV4dC1hbGlnbjpjZW50ZXIiIGZvbnQtd2VpZ2h0PSJib2xkIiB4bWw6c3BhY2U9InByZXNlcnZlIiBmb250LXNpemU9IjEwcHgiIGxpbmUtaGVpZ2h0PSIxMjUlIiB5PSI5NzAuNzI4MDkiIHg9IjQ5LjM5NjQ3NyIgZm9udC1mYW1pbHk9IlJvYm90byIgZmlsbD0iIzY2NjY2NiI+PHRzcGFuIGlkPSJ0c3BhbjQ2OTAiIHg9IjUwLjY0NjQ3NyIgeT0iOTcwLjcyODA5Ij5JbWFnZSBiYWNrZ3JvdW5kIDwvdHNwYW4+PHRzcGFuIGlkPSJ0c3BhbjQ2OTIiIHg9IjQ5LjM5NjQ3NyIgeT0iOTgzLjIyODA5Ij5pcyBub3QgY29uZmlndXJlZDwvdHNwYW4+PC90ZXh0PgogIDxyZWN0IGlkPSJyZWN0NDY5NCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgaGVpZ2h0PSIxOS4zNiIgd2lkdGg9IjY5LjM2IiBzdHJva2U9IiMwMDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgeT0iOTkyLjY4IiB4PSIxNS4zMiIgc3Ryb2tlLXdpZHRoPSIuNjM5ODYiIGZpbGw9Im5vbmUiLz4KIDwvZz4KPC9zdmc+Cg==\",\"labels\":[{\"pattern\":\"Value: ${#0:2} units.\",\"font\":{\"color\":\"#515151\",\"family\":\"Roboto\",\"size\":6,\"style\":\"normal\",\"weight\":\"500\"},\"x\":0,\"y\":0}]},\"title\":\"WIDGET MAP\",\"dropShadow\":true,\"enableFullscreen\":true,\"titleStyle\":{\"fontSize\":\"16px\",\"fontWeight\":400}}"
      }
    }
  ]
}
